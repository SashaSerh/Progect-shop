# Автоочистка неиспользуемых изображений (picture/)

> См. также: «Добавление товара локально и привязка изображения» — файл `docs/local-product-add.md`.

Этот проект генерирует responsive-варианты изображений (включая WebP/AVIF и LQIP), из-за чего при удалении товара могут оставаться «осиротевшие» файлы. Чтобы поддерживать папку `picture/` в чистоте, добавлен CLI-скрипт автоочистки.

## Что делает скрипт
- Сканирует JSON с товарами (`data/products.local.json` и/или `data/products.json`) и собирает список используемых изображений.
- Сопоставляет их с файлами в `picture/`, понимая текущую схему имён:
  - `base.ext`
  - `base-<width>w.ext` (оригинальный формат)
  - `base-<width>w.webp` / `base-<width>w.avif`
  - `base-lqip.*`
- Удаляет все файлы, чья «база имени» (без суффиксов размера/LQIP и расширения) не встречается в продуктах.

## Быстрый старт
- Предпросмотр (ничего не удаляет):
  - `npm run images:cleanup:dry`
- Фактическая очистка (без подтверждения):
  - `npm run images:cleanup`

По умолчанию скрипт использует:
- `--dir picture`
- `--json data/products.local.json,data/products.json`

Вы можете переопределить аргументы вручную:

```sh
node scripts/cleanup-pictures.js --dir picture --json data/products.local.json --dry-run
node scripts/cleanup-pictures.js --dir picture --json data/products.local.json,data/products.json --yes
```

## Рекомендации по использованию
1. Сначала всегда запускайте dry-run, чтобы увидеть список кандидатов на удаление.
2. После массовых изменений (удаление/замена изображений, пересборка responsive-вариантов) прогоните:
   - `npm run images:cleanup:dry`
   - Если список корректен → `npm run images:cleanup`
3. После добавления/замены изображений не забывайте генерировать responsive-варианты:
   - `npm run images:gen`

Дополнительно про добавление товаров и первичную привязку изображений — в `docs/local-product-add.md`.

## Ограничения и заметки
- Скрипт работает только с локальной папкой `picture/` и не затрагивает Supabase Storage.
- Для Supabase Storage можно реализовать отдельный маршрут в Edge Function (например, DELETE по списку путей) — это отдельная задача.
- Скрипт целенаправленно «группирует» варианты по «базе имени», поэтому при удалении «базы», будут удалены все связанные размеры и LQIP.
