<section id="adminProductsPage" class="admin-products-page">
  <div class="container">
    <header class="admin-page__header">
      <nav class="admin-breadcrumbs" aria-label="Хлебные крошки">
        <a href="#products" class="admin-breadcrumbs__link" data-i18n="admin-breadcrumbs-root">Каталог</a>
        <span class="admin-breadcrumbs__sep">/</span>
        <span class="admin-breadcrumbs__current" data-i18n="admin-breadcrumbs-current">Админ: Товары</span>
      </nav>
      <div class="admin-page__actions">
        <a href="#products" class="btn btn--ghost" aria-label="Назад в каталог" data-i18n="admin-back">← Назад</a>
        <button id="adminExportBtn" type="button" class="btn" data-i18n="admin-export-json">Экспорт JSON</button>
        <label class="btn btn--secondary" for="adminImportInput" data-i18n="admin-import-json">Импорт JSON</label>
        <input id="adminImportInput" type="file" accept="application/json" hidden>
        <button id="clearConflictsBtn" type="button" class="btn btn--ghost" title="Сбросить конфликты" data-i18n="admin-clear-conflicts">Очистить конфликты</button>
      </div>
      <details class="admin-gitcms" id="gitcmsSettingsAdmin">
        <summary data-i18n="admin-remote-title">Удалённые данные</summary>
        <div class="gitcms-form">
          <label data-i18n="admin-remote-provider">Провайдер
            <select id="dataProviderSelect">
              <option value="localStorage">LocalStorage</option>
              <option value="supabase">Supabase</option>
            </select>
          </label>
          <!-- Supabase settings only -->
          <label data-i18n="admin-remote-supabase-url">Supabase URL
            <input id="supabaseUrl" placeholder="https://xyzcompany.supabase.co">
          </label>
          <label data-i18n="admin-remote-supabase-key">Supabase Key
            <input id="supabaseKey" type="password" placeholder="anon or service key">
          </label>
          <label data-i18n="admin-remote-supabase-table">Supabase Table
            <input id="supabaseTable" placeholder="products">
          </label>
          <label data-i18n="admin-remote-supabase-schema">Supabase Schema
            <input id="supabaseSchema" placeholder="public" value="public">
          </label>
          <!-- Optional proxy settings for secure push -->
          <label data-i18n="admin-remote-proxy-use" title="Отправлять запись через ваш API-прокси">
            <input id="proxyUse" type="checkbox"> Использовать прокси для Push
          </label>
          <label data-i18n="admin-remote-proxy-url">Proxy URL
            <input id="proxyUrl" placeholder="https://api.example.com/products/sync" data-i18n-placeholder="admin-remote-proxy-url-ph">
          </label>
          <label data-i18n="admin-remote-proxy-token">Proxy Token (опц.)
            <input id="proxyToken" type="password" placeholder="секрет для X-Admin-Sync-Token" data-i18n-placeholder="admin-remote-proxy-token-ph">
          </label>
          <!-- GitHub (Git-CMS) settings -->
          <fieldset class="gitcms-github">
            <legend>GitHub (products.json)</legend>
            <label data-i18n="admin-remote-git-repo">Repo (owner/repo)
              <input id="gitRepo" placeholder="owner/name">
            </label>
            <label data-i18n="admin-remote-git-branch">Ветка
              <input id="gitBranch" placeholder="main" value="main">
            </label>
            <label data-i18n="admin-remote-git-path">Путь
              <input id="gitPath" placeholder="data/products.json" value="data/products.json">
            </label>
            <label data-i18n="admin-remote-git-token">Токен
              <input id="gitToken" type="password" placeholder="ghp_...">
            </label>
            <label title="После сохранения товара локально, дополнительно выполнится коммит products.json в GitHub">
              <input id="gitAutoCommit" type="checkbox"> Автозапись в GitHub при «Сохранить»
            </label>
          </fieldset>
          <div class="gitcms-actions">
            <button type="button" id="gitcmsSaveBtn" data-i18n="admin-remote-save">Сохранить</button>
            <button type="button" id="gitcmsLoadBtn" title="Загрузить товары из удалённого провайдера в локальные" data-i18n="admin-remote-load">Загрузить</button>
            <button type="button" id="gitcmsLoadFromGitBtn" data-i18n="admin-remote-github-load" data-i18n-title="admin-remote-github-load-title" title="Загрузить products.json из GitHub в локальные (без смены провайдера)">Загрузить из GitHub</button>
            <button type="button" id="gitcmsMergeBtn" title="Загрузить из удалённого провайдера и слить с текущими" data-i18n="admin-remote-merge">Загрузить и слить</button>
            <button type="button" id="gitcmsPushBtn" title="Записать локальные товары в удалённый провайдер" data-i18n="admin-remote-push">Записать</button>
            <span id="gitcmsStatus" aria-live="polite" style="margin-left:8px; font-size:12px;"></span>
          </div>
        </div>
      </details>
    </header>

    <div class="admin-page__content">
      <aside class="admin-page__list">
        <h3 class="admin-block__title" data-i18n="admin-local-products">Локальные товары</h3>
        <ul id="adminLocalProductsList" class="admin-list"></ul>
      </aside>

      <main class="admin-page__formwrap">
        <h3 class="admin-block__title" data-i18n="admin-form-title">Добавить / Редактировать</h3>
        <form id="adminProductForm" class="admin-product-form">
          <input type="hidden" name="id">
          <div class="form-row">
            <label><span data-i18n="admin-field-title-ru">Название (RU)</span>
              <input name="title_ru" required>
              <small class="form-error" data-for="title_ru" role="alert"></small>
            </label>
            <label><span data-i18n="admin-field-title-uk">Название (UK)</span>
              <input name="title_uk">
            </label>
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-desc-ru">Короткое описание (RU)</span>
              <textarea name="description_ru"></textarea>
            </label>
            <label><span data-i18n="admin-field-desc-uk">Короткое описание (UK)</span>
              <textarea name="description_uk"></textarea>
            </label>
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-price">Цена</span>
              <input name="price" type="number" min="0" step="1" required>
              <small class="form-error" data-for="price" role="alert"></small>
            </label>
            <label><span data-i18n="admin-field-sku">SKU</span>
              <input name="sku" required>
              <small class="form-error" data-for="sku" role="alert"></small>
              <small class="form-hint" data-i18n="admin-hint-sku-required">Обязательное поле</small>
            </label>
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-category">Категория</span>
              <input name="category" placeholder="ac / recuperator / service">
              <small class="form-error" data-for="category" role="alert"></small>
            </label>
            <label><span data-i18n="admin-field-in-stock">В наличии</span>
              <select name="inStock">
                <option value="true" data-i18n="admin-in-stock-yes">Да</option>
                <option value="false" data-i18n="admin-in-stock-no">Нет</option>
              </select>
            </label>
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-image">Главное изображение</span>
              <input name="image" type="file" accept="image/*">
            </label>
            <div id="adminImagePreview" aria-hidden="true"></div>
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-gallery">Галерея изображений</span>
              <input name="images" type="file" accept="image/*" multiple>
            </label>
            <div id="adminImagesPreview" class="images-preview" aria-hidden="true"></div>
            <input type="hidden" name="_images_urls" value="[]">
          </div>
          <div class="form-row">
            <label><span data-i18n="admin-field-flags">Флаги</span>
              <div id="flagSelector" class="flag-selector">
                <div id="availableFlags" class="available-flags" aria-live="polite"></div>
                <div id="selectedFlags" class="selected-flags" aria-live="polite"></div>
                <input type="hidden" name="_flags" value="[]">
              </div>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" id="adminProductSave" class="btn btn--primary" data-i18n="admin-save">Сохранить</button>
            <button type="button" id="adminSaveImageBtn" class="btn btn--secondary" data-i18n="admin-save-image" title="Сохранить выбранное изображение в picture/conditioners">Сохранить изображение</button>
            <button type="button" id="adminSaveImagesBtn" class="btn btn--secondary" data-i18n="admin-save-images" title="Сохранить выбранные изображения (галерею) в picture/conditioners">Сохранить изображения</button>
            <button type="button" id="adminExportToProductsBtn" class="btn" data-i18n="admin-export-to-productsjson" title="Добавить текущий товар в data/products.json (локально, через доступ к файлам)">Добавить в products.json</button>
            <button type="reset" id="adminProductCancel" class="btn btn--secondary" data-i18n="admin-reset">Сброс</button>
          </div>
        </form>
      </main>
    </div>
  </div>
</section>

<!-- Diff modal for conflict preview -->
<div class="modal" id="conflictDiffModal" role="dialog" aria-modal="true" aria-labelledby="conflictDiffTitle" style="display:none;">
  <div class="modal__content">
    <button class="modal__close" type="button" aria-label="Закрыть">✕</button>
    <h3 id="conflictDiffTitle">Различия</h3>
    <div id="conflictDiffContent"></div>
  </div>
  <div class="modal__backdrop" aria-hidden="true"></div>
  <script>
    (function(){
      const modal = document.getElementById('conflictDiffModal');
      if (!modal) return;
      const closeBtn = modal.querySelector('.modal__close');
      const backdrop = modal.querySelector('.modal__backdrop');
      function close(){ modal.style.display='none'; }
      closeBtn && closeBtn.addEventListener('click', close);
      backdrop && backdrop.addEventListener('click', close);
      modal.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>
</div>
